# Вычислительное ядро статистического анализа на Python

## Что реализовано

Данный сервер представляет собой вычислительное ядро для статистического анализа данных, реализованное на языке Python. Сервер предоставляет следующие функциональные возможности:

1. **Загрузка и предобработка данных**:
   - Поддержка форматов CSV и Excel (XLSX)
   - Автоматическое определение разделителей в CSV файлах
   - Валидация входных данных

2. **Описательная статистика**:
   - Базовые статистические показатели (среднее, медиана, мода)
   - Меры разброса (дисперсия, стандартное отклонение)
   - Коэффициент вариации
   - Анализ формы распределения (асимметрия, эксцесс)
   - Определение минимальных и максимальных значений
   - Построение гистограмм распределения

3. **Тесты на нормальность распределения**:
   - Тест Шапиро-Уилка
   - Критерий согласия хи-квадрат Пирсона

4. **Доверительные интервалы**:
   - Расчет доверительных интервалов для среднего значения
   - Настраиваемый уровень доверия (по умолчанию 95%)

5. **Регрессионный анализ**:
   - Линейная регрессия (через OLS и curve_fit)
   - Квадратичная регрессия
   - Степенная регрессия
   - Экспоненциальная регрессия
   - Логарифмическая регрессия
   - Тригонометрическая регрессия
   - Сигмоидная регрессия
   - Оценка качества моделей (R², скорректированный R², F-статистика, p-значение, SSE)

6. **Анализ остатков регрессии**:
   - Тест на нормальность остатков
   - Построение гистограмм остатков
   - Подготовка данных для QQ-графиков

7. **Тесты Вилкоксона**:
   - Тест знаковых рангов Вилкоксона для связанных (парных) выборок
   - Тест Манна-Уитни (U-тест) для независимых выборок

## Как реализовано

Проект реализован с использованием **гексагональной архитектуры** (также известной как "порты и адаптеры"), что обеспечивает:
- Четкое разделение ответственности между компонентами
- Возможность независимого тестирования модулей
- Гибкость в замене реализаций компонентов

### Структура проекта:

```
python-server/
├── analysis_modules/         # Модули с алгоритмами статистического анализа
│   ├── confidence_interval.py
│   ├── descriptive.py
│   ├── goodness_of_fit.py
│   ├── normality.py
│   ├── regression.py
│   ├── residuals_analysis.py
│   └── wilcoxon.py
├── internal/                 # Внутренняя структура приложения
│   ├── adapters/             # Адаптеры для порт-интерфейсов
│   │   ├── confidence_interval.py
│   │   ├── data_loader.py
│   │   ├── descriptive_stats.py
│   │   ├── goodness_of_fit.py
│   │   ├── grpc_server.py
│   │   ├── normality_test.py
│   │   ├── regression.py
│   │   ├── residuals_analysis.py
│   │   └── wilcoxon_test.py
│   └── core/                 # Ядро приложения (бизнес-логика)
│       ├── domain/           # Бизнес-сущности
│       │   └── entities.py
│       ├── ports/            # Интерфейсы для адаптеров
│       │   ├── analysis_ports.py
│       │   └── wilcoxon_test_port.py
│       └── services/         # Реализация бизнес-логики
│           └── analysis_service.py
├── analysis_pb2.py           # Сгенерированные классы Protocol Buffers
├── analysis_pb2_grpc.py      # Сгенерированные gRPC сервисы
├── analysis_pb2.pyi          # Типизированные интерфейсы
├── main.py                   # Точка входа в приложение
└── requirements.txt          # Зависимости проекта
```

### Технологический стек:

- **Python 3.8+** - Основной язык программирования
- **gRPC** - Фреймворк для удаленного вызова процедур
- **Protocol Buffers** - Механизм сериализации структурированных данных
- **pandas** - Библиотека для работы с табличными данными
- **NumPy** - Библиотека для научных вычислений
- **SciPy** - Библиотека для статистических вычислений
- **statsmodels** - Библиотека для статистического моделирования

### Принцип работы:

1. **Прием запроса** - gRPC сервер принимает запрос с содержимым файла и перечнем требуемых видов анализа
2. **Загрузка данных** - Содержимое файла преобразуется в DataFrame для дальнейшей обработки
3. **Выполнение анализа** - Выполняются запрошенные виды анализа
4. **Формирование ответа** - Результаты анализа упаковываются в ответный объект
5. **Отправка результата** - Ответ сериализуется и отправляется клиенту через gRPC

## Реализация статистических алгоритмов

### 1. Описательная статистика (descriptive.py)

Модуль реализует расчет основных статистических показателей для числовых переменных:

- **Базовые статистики**: средние значения вычисляются через `pandas.DataFrame.mean()`, медиана через `pandas.DataFrame.median()`, мода через `pandas.Series.mode()`
- **Меры разброса**: дисперсия вычисляется с помощью `pandas.DataFrame.var()`, стандартное отклонение через `pandas.DataFrame.std()`
- **Коэффициент вариации**: рассчитывается как отношение стандартного отклонения к среднему значению, умноженное на 100%
- **Анализ формы распределения**: асимметрия вычисляется через `scipy.stats.skew()`, эксцесс через `scipy.stats.kurtosis()` с параметром `fisher=True`
- **Гистограммы**: строятся с использованием `numpy.histogram()` с автоматическим определением количества бинов по методу Стёрджесса

### 2. Тесты на нормальность (normality.py)

- **Тест Шапиро-Уилка**: реализован с использованием функции `scipy.stats.shapiro()`, которая вычисляет W-статистику и p-значение
- **Интерпретация результатов**: если p-значение > 0.05, то принимается гипотеза о нормальности распределения

### 3. Критерий хи-квадрат (goodness_of_fit.py)

- **Критерий согласия Пирсона**: реализован с использованием функции `scipy.stats.chisquare()`
- **Алгоритм**:
  1. Разбиение данных на равные интервалы (количество интервалов определяется по формуле Стёрджесса)
  2. Подсчет наблюдаемых частот в каждом интервале
  3. Расчет теоретических частот на основе нормального распределения с параметрами выборки
  4. Вычисление статистики хи-квадрат и p-значения
  5. Сравнение p-значения с уровнем значимости для принятия/отклонения гипотезы о нормальности

### 4. Доверительные интервалы (confidence_interval.py)

- **Расчет доверительных интервалов для среднего**: использует функцию `scipy.stats.t.interval()` с аргументами:
  - Уровень доверия (по умолчанию 0.95)
  - Степени свободы (n-1, где n - размер выборки)
  - Среднее значение выборки
  - Стандартная ошибка среднего (стандартное отклонение, деленное на корень из размера выборки)

### 5. Регрессионный анализ (regression.py)

Модуль поддерживает различные типы регрессий:

- **Линейная регрессия**: 
  - Метод OLS (Ordinary Least Squares) из `statsmodels.api.OLS`
  - Альтернативный метод через `scipy.optimize.curve_fit` для y = ax + b
  - Оценка коэффициентов, стандартных ошибок, t-статистик, p-значений и доверительных интервалов
  - **Расчет коэффициентов**: 
    - В методе OLS используется матричное уравнение β = (X^T X)^(-1) X^T Y, где X - матрица независимых переменных, Y - вектор зависимой переменной
    - Стандартные ошибки коэффициентов вычисляются из диагональных элементов матрицы (X^T X)^(-1) * σ², где σ² - оценка дисперсии ошибок
  - **Расчет доверительных интервалов для коэффициентов**:
    - Для OLS используется встроенный метод `results.conf_int(alpha=0.05)` из statsmodels
    - Формула: [β_i ± t_(n-p, 1-α/2) * se(β_i)], где:
      - β_i - оценка коэффициента
      - t_(n-p, 1-α/2) - критическое значение t-распределения с (n-p) степенями свободы
      - n - число наблюдений
      - p - число параметров модели
      - se(β_i) - стандартная ошибка коэффициента
      - α - уровень значимости (0.05 для 95% доверительного интервала)

- **Нелинейные регрессии** - все реализованы через `scipy.optimize.curve_fit`:
  - **Квадратичная**: y = ax² + bx + c
    - **Расчет коэффициентов**: преобразование в линейную модель с двумя предикторами (x² и x) или оптимизация методом Левенберга-Марквардта через `curve_fit`
  - **Степенная**: y = ax^b
    - **Расчет коэффициентов**: логарифмирование уравнения ln(y) = ln(a) + b*ln(x) и применение линейной регрессии или напрямую через `curve_fit`
  - **Экспоненциальная**: y = ae^(bx)
    - **Расчет коэффициентов**: логарифмирование уравнения ln(y) = ln(a) + bx и применение линейной регрессии или итеративная оптимизация через `curve_fit`
  - **Логарифмическая**: y = a + b*ln(x)
    - **Расчет коэффициентов**: преобразование ln(x) в новую переменную и применение линейной регрессии
  - **Тригонометрическая**: y = a*sin(bx + c) + d
    - **Расчет коэффициентов**: нелинейная оптимизация с начальными приближениями через алгоритм Левенберга-Марквардта в `curve_fit`
  - **Сигмоидная**: y = a / (1 + e^(-b(x-c)))
    - **Расчет коэффициентов**: нелинейная оптимизация через `curve_fit` с самоограничивающейся функцией потерь для устойчивости алгоритма
  - **Расчет доверительных интервалов для нелинейных моделей**:
    - Стандартные ошибки извлекаются из диагональных элементов ковариационной матрицы, возвращаемой `curve_fit`: `std_errors = np.sqrt(np.diag(covariance))`
    - Критическое значение t-распределения вычисляется через `stats.t.ppf(1 - 0.05/2, df_error)`, где df_error = n - p (степени свободы)
    - Доверительные интервалы: [параметр ± t_критическое × стандартная_ошибка]
    - Для сигмоидной и тригонометрической моделей доверительные интервалы могут быть неточными из-за сложности поверхности ошибок

- **Процесс оптимизации нелинейных регрессий**:
  1. Определение целевой функции модели (например, y = ae^(bx))
  2. Выбор начальных значений параметров (часто через эвристики или предварительное линейное приближение)
  3. Итеративная минимизация суммы квадратов остатков (SSR) с использованием алгоритма Левенберга-Марквардта
     - На каждой итерации вычисляется матрица Якоби (первые производные функции по каждому параметру)
     - Параметры корректируются в направлении, минимизирующем ошибку между моделью и данными
     - Процесс останавливается при достижении сходимости (изменение параметров меньше порога или достижение максимального числа итераций)
  4. Оценка стандартных ошибок параметров из ковариационной матрицы, возвращаемой `curve_fit`

- **Оценка качества моделей**:
  - Коэффициент детерминации R² = 1 - SSR/SST, где SSR - сумма квадратов остатков, SST - общая сумма квадратов
  - Скорректированный R² = 1 - (1-R²)*(n-1)/(n-p-1), где n - число наблюдений, p - число предикторов
  - F-статистика = (R²/p)/((1-R²)/(n-p-1)) и соответствующее p-значение из F-распределения
  - Сумма квадратов ошибок (SSE)

### 6. Анализ остатков регрессии (residuals_analysis.py)

- **Расчет остатков**: разница между наблюдаемыми значениями и предсказанными моделью
- **Тест на нормальность остатков**: использует тест Шапиро-Уилка из `scipy.stats.shapiro()`
- **Гистограмма остатков**: строится с помощью `numpy.histogram()`
- **QQ-график**: подготавливает данные с использованием `scipy.stats.probplot()`

### 7. Тесты Вилкоксона (wilcoxon.py)

- **Тест знаковых рангов Вилкоксона**:
  - Реализация через `scipy.stats.wilcoxon()`
  - Алгоритм проверки:
    1. Вычисление разностей между парными наблюдениями
    2. Исключение нулевых разностей
    3. Ранжирование абсолютных значений разностей
    4. Присвоение рангам знаков исходных разностей
    5. Вычисление суммы рангов с положительными и отрицательными знаками
    6. Расчет статистики W как минимальное из двух сумм
    7. Определение критического значения и p-значения

- **Тест Манна-Уитни (U-тест)**:
  - Реализация через `scipy.stats.mannwhitneyu()`
  - Алгоритм проверки:
    1. Комбинация двух выборок и ранжирование всех наблюдений
    2. Вычисление суммы рангов для каждой выборки
    3. Расчет статистики U на основе сумм рангов и размеров выборок
    4. Определение p-значения исходя из распределения статистики U

## Зачем реализовано

Этот сервер представляет собой вычислительное ядро для статистического анализа данных, которое используется в рамках более крупной системы. Основные цели:

1. **Изоляция вычислительной логики** - Отделение тяжелых вычислений от основного приложения
2. **Использование преимуществ Python** - Доступ к богатой экосистеме библиотек для научных расчетов и статистики
3. **Масштабируемость** - Возможность независимого масштабирования вычислительного сервера
4. **Интерфейс для внешних систем** - Предоставление стандартизированного API для доступа к статистическим алгоритмам

### Аналитические методы в деталях:

#### Описательная статистика
Реализованы базовые статистические метрики, которые позволяют получить первое представление о данных без использования сложных алгоритмов. Они дают информацию о центральной тенденции, разбросе и форме распределения.

#### Тесты на нормальность
Тест Шапиро-Уилка и критерий хи-квадрат используются для проверки гипотезы о нормальности распределения, что является важным предварительным шагом перед применением многих параметрических методов статистики.

#### Регрессионный анализ
Реализованы различные типы регрессий, которые позволяют моделировать зависимости между переменными. Поддерживаются как линейные, так и нелинейные модели, что дает возможность подобрать наиболее подходящую модель для конкретных данных.

#### Анализ остатков
Анализ остатков регрессии позволяет оценить качество регрессионной модели и выполнить диагностику потенциальных проблем (гетероскедастичность, автокорреляция и т.д.).

#### Тесты Вилкоксона
Тест знаковых рангов Вилкоксона и тест Манна-Уитни представляют собой непараметрические методы для сравнения выборок, которые могут использоваться, когда условия для применения параметрических методов (например, t-критерия Стьюдента) не выполняются.

## Запуск проекта

### Предварительные требования
- Python 3.8 или выше
- pip (менеджер пакетов Python)

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Запуск сервера
```bash
python main.py
```

По умолчанию сервер запускается на порту 9000 и принимает соединения со всех сетевых интерфейсов. 